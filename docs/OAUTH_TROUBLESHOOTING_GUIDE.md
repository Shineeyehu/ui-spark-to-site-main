# OAuth 过期问题排查指南

## 问题描述

错误信息：`Oauth过期，无法查看智能体，请检查你的网址或加入对应工作空间后重试`

错误 ID：`a6cfb972-c198-4b91-8bbf-8226d1fda05f`

## 可能原因

### 1. OAuth 应用配置问题

**问题**：OAuth 应用配置不正确或已过期

**检查步骤**：
1. 登录 [扣子平台](https://www.coze.cn)
2. 进入 OAuth 应用管理页面
3. 检查应用状态是否正常
4. 验证 Client ID 和 Client Secret 是否正确

**修复方法**：
- 重新创建 OAuth 应用
- 更新环境变量中的 Client ID 和 Client Secret

### 2. 工作空间权限问题

**问题**：OAuth 应用没有访问对应工作空间的权限

**检查步骤**：
1. 确认 OAuth 应用是否在正确的工作空间中
2. 检查应用权限设置
3. 确认用户是否已加入对应工作空间

**修复方法**：
- 将 OAuth 应用移动到正确的工作空间
- 确保用户已加入对应工作空间
- 检查应用权限设置

### 3. 重定向 URI 不匹配

**问题**：OAuth 应用配置的重定向 URI 与当前域名不匹配

**检查步骤**：
1. 检查当前域名：`window.location.origin`
2. 检查 OAuth 应用配置的重定向 URI
3. 确保两者完全匹配

**修复方法**：
- 更新 OAuth 应用配置中的重定向 URI
- 确保包含完整的回调路径：`http://localhost:8082/oauth/callback`

### 4. 令牌过期或无效

**问题**：访问令牌已过期或无效

**检查步骤**：
1. 检查本地存储中的令牌
2. 验证令牌格式和有效性
3. 尝试刷新令牌

**修复方法**：
- 清除本地存储的令牌
- 重新进行 OAuth 授权
- 检查令牌刷新机制

## 快速修复步骤

### 步骤 1：清除现有令牌

```javascript
// 在浏览器控制台中执行
localStorage.removeItem('coze_oauth_tokens');
location.reload();
```

### 步骤 2：检查 OAuth 配置

访问 `http://localhost:8082/coze-test` 并使用 OAuth 诊断工具检查配置。

### 步骤 3：重新授权

1. 点击"开始授权"按钮
2. 在扣子平台完成授权流程
3. 确认授权成功

### 步骤 4：验证工作空间

1. 登录 [扣子平台](https://www.coze.cn)
2. 确认已加入正确的工作空间
3. 检查 OAuth 应用是否在该工作空间中

## 详细排查步骤

### 1. 检查环境变量

确保以下环境变量已正确设置：

```bash
# .env.local 文件
VITE_COZE_CLIENT_ID=08461612714393126791235695948705.app.coze
VITE_COZE_CLIENT_SECRET=6JdTe15fTYT2a6FLcZeZWCFbj0ashyGVAA4NiIxz4VrQBxFA
VITE_COZE_REDIRECT_URI=http://localhost:8082/oauth/callback
VITE_COZE_USE_JWT=true
```

### 2. 检查 OAuth 应用配置

在扣子平台中：

1. 进入 OAuth 应用管理
2. 检查应用状态
3. 验证重定向 URI 设置
4. 检查权限范围设置

**正确的重定向 URI 格式**：
```
http://localhost:8082/oauth/callback
```

**权限范围应包括**：
```
chat:read chat:write bot:read
```

### 3. 检查工作空间设置

1. 确认 OAuth 应用在正确的工作空间中
2. 检查工作空间 ID 是否匹配
3. 确认用户已加入该工作空间

### 4. 检查网络和浏览器

1. 尝试禁用浏览器扩展
2. 清除浏览器缓存和 Cookie
3. 尝试使用无痕模式
4. 检查网络连接

## 使用诊断工具

### 1. 访问诊断页面

访问 `http://localhost:8082/coze-test` 并找到 "OAuth 诊断工具" 部分。

### 2. 运行诊断

点击"运行诊断"按钮，系统会自动检查：

- OAuth 配置完整性
- 当前认证状态
- 令牌有效性
- 重定向 URI 匹配
- 工作空间访问权限

### 3. 查看结果

根据诊断结果采取相应的修复措施：

- **成功**：配置正常，无需操作
- **警告**：需要关注，建议修复
- **错误**：必须修复才能正常工作

## 常见错误和解决方案

### 错误 1：Client ID 无效

**症状**：OAuth 授权页面显示"无效的客户端"

**解决方案**：
1. 检查 Client ID 是否正确
2. 确认 OAuth 应用状态正常
3. 重新创建 OAuth 应用

### 错误 2：重定向 URI 不匹配

**症状**：OAuth 授权后无法正确回调

**解决方案**：
1. 检查重定向 URI 配置
2. 确保域名和路径完全匹配
3. 更新 OAuth 应用配置

### 错误 3：权限不足

**症状**：授权成功但无法访问智能体

**解决方案**：
1. 检查 OAuth 应用权限设置
2. 确认工作空间权限
3. 重新授权并选择正确的工作空间

### 错误 4：令牌过期

**症状**：之前能正常工作，现在提示过期

**解决方案**：
1. 清除本地存储的令牌
2. 重新进行 OAuth 授权
3. 检查令牌刷新机制

## 预防措施

### 1. 定期检查配置

- 定期验证 OAuth 应用状态
- 检查环境变量配置
- 监控令牌过期时间

### 2. 设置监控

- 添加令牌过期提醒
- 监控 OAuth 授权状态
- 记录错误日志

### 3. 备份配置

- 保存 OAuth 应用配置信息
- 备份环境变量
- 记录工作空间设置

## 联系支持

如果问题仍然存在，请提供：

1. 完整的错误信息
2. 浏览器控制台日志
3. OAuth 诊断工具的结果
4. 当前环境变量配置
5. 扣子平台 OAuth 应用配置截图

---

**注意**：本指南基于扣子平台的 OAuth 2.0 实现。如果平台有更新，请参考最新的官方文档。
