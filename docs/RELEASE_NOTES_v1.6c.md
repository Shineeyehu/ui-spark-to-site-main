# v1.6c 发布说明

发布日期：2025-09-19
提交基线：v1.6c @ f69f052

## 本次更新亮点
- 深度咨询（DeepTalk）体验优化：
  - 新增 isDeepTalk 模式开关，深度咨询页面完全禁用手相图片上传与提示。
  - 过滤 Coze API 返回中的系统/检索类消息（verbose/knowledge_recall/time_capsule_recall），仅保留真实助手回复。
  - 从深度咨询返回报告页时，优先还原 `inlineReportHtml`，无缝回到上次生成的报告。

- 报告渲染品质提升：
  - 智能 Markdown 标题解析：修复同一行多个标题（如 `##…####…`）无法正确渲染的问题。
  - 增强 Markdown 清理与容错，减少残留符号，保证段落化展示稳定。
  - “命主信息概览”渲染时移除 `<img>/<figure>`，避免不必要图片干扰。
  - 报告页空状态逻辑优化：从深度咨询返回时不再显示预置示意图。

## 详细变更
### 功能
- DeepTalk：
  - `CozeV3Chat` 新增 `isDeepTalk`，深度咨询对话仅文本上下文，不再上传/提示手相图片。
  - 调整上下文拼装，深度咨询模式下不拼接“手相信息”行。
  - 对 Coze 消息列表进行类型过滤，优先提取 `answer` 类型助手消息。

- 报告页（ReportPage）：
  - 返回自深度咨询时：优先使用 `inlineReportHtml`，其次回退 `moonshotResult`。
  - 空状态增加约束：`!fromDeepTalk && !generatedHTML` 才显示预置图片。
  - “命主信息概览”转换后移除图片标签，统一样式。

- Markdown 处理：
  - 新增智能标题拆分 `##…####…` 为独立行，交由 `marked` 正确转 HTML。
  - 提供清理通道，将不规范 Markdown 转为干净文本段落作为兜底。

### 修复
- 修复空的 catch 代码块与若干转义字符引发的构建/ESLint 报错。
- 修复因导航返回导致显示预置图片的问题。

## 兼容性
- 无破坏性接口变更。新增 `CozeV3Chat` 可选属性 `isDeepTalk`（默认 false），不影响现有调用。

## 升级指引
1. 拉取 v1.6c 最新代码。
2. 若使用深度咨询页，确保向 `CozeV3Chat` 传入 `isDeepTalk={true}`。
3. 如有自定义 Markdown 渲染逻辑，可复用 `markdown-utils.ts` 的智能解析与清理方法。

## 验证清单（建议）
- 深度咨询页：对话流程中不出现“手相图片失败/请上传图片”提示。
- 从深度咨询“返回报告”：展示上次生成的报告，无预置图片。
- 报告页“命主信息概览”：不包含 `<img>`，标题层级正确，分隔线/列表渲染正常。
- Coze 对话：过滤系统消息后，只显示助手实质回复。

## 已知问题
- 个别 Hook 依赖存在 ESLint 告警，不影响功能。后续版本统一整理依赖数组。


