# OAuth 过期问题快速修复指南

## 问题症状

错误信息：`Oauth过期，无法查看智能体，请检查你的网址或加入对应工作空间后重试`

错误 ID：`a6cfb972-c198-4b91-8bbf-8226d1fda05f`

## 快速修复步骤

### 方法 1：使用诊断工具（推荐）

1. **访问诊断页面**
   - 打开 `http://localhost:8082/coze-test`
   - 找到 "OAuth 诊断工具" 部分

2. **运行诊断**
   - 点击 "运行诊断" 按钮
   - 查看诊断结果和修复建议

3. **一键修复**
   - 点击 "一键修复" 按钮
   - 系统会自动清除过期数据并重新配置

4. **重新授权**
   - 点击 "开始授权" 按钮
   - 在扣子平台完成授权流程

### 方法 2：手动清除数据

1. **清除浏览器数据**
   ```javascript
   // 在浏览器控制台中执行
   localStorage.removeItem('coze_oauth_tokens');
   localStorage.removeItem('coze_oauth_state');
   localStorage.removeItem('coze_auth_data');
   sessionStorage.clear();
   location.reload();
   ```

2. **重新授权**
   - 访问 `http://localhost:8082/coze-test`
   - 点击 "开始授权" 按钮
   - 完成 OAuth 授权流程

### 方法 3：检查配置

1. **检查环境变量**
   确保 `.env.local` 文件包含：
   ```bash
   VITE_COZE_CLIENT_ID=08461612714393126791235695948705.app.coze
   VITE_COZE_CLIENT_SECRET=6JdTe15fTYT2a6FLcZeZWCFbj0ashyGVAA4NiIxz4VrQBxFA
   VITE_COZE_REDIRECT_URI=http://localhost:8082/oauth/callback
   VITE_COZE_USE_JWT=true
   ```

2. **检查 OAuth 应用配置**
   - 登录 [扣子平台](https://www.coze.cn)
   - 检查 OAuth 应用状态
   - 确认重定向 URI 设置正确
   - 验证工作空间权限

## 常见问题解决

### 问题 1：重定向 URI 不匹配

**症状**：授权后无法正确回调

**解决方案**：
1. 检查当前域名：`http://localhost:8082`
2. 确保 OAuth 应用配置的重定向 URI 为：`http://localhost:8082/oauth/callback`
3. 更新 OAuth 应用配置

### 问题 2：工作空间权限不足

**症状**：授权成功但无法访问智能体

**解决方案**：
1. 确认已加入正确的工作空间
2. 检查 OAuth 应用是否在该工作空间中
3. 验证应用权限设置

### 问题 3：令牌格式错误

**症状**：令牌获取失败

**解决方案**：
1. 清除所有本地存储的令牌
2. 重新进行 OAuth 授权
3. 检查令牌格式是否正确

### 问题 4：浏览器扩展干扰

**症状**：授权流程异常

**解决方案**：
1. 禁用所有浏览器扩展
2. 使用无痕模式
3. 清除浏览器缓存

## 预防措施

### 1. 定期检查

- 定期运行 OAuth 诊断工具
- 监控令牌过期时间
- 检查配置状态

### 2. 配置备份

- 保存 OAuth 应用配置信息
- 备份环境变量
- 记录工作空间设置

### 3. 监控设置

- 添加令牌过期提醒
- 设置自动刷新机制
- 记录错误日志

## 使用诊断工具

### 功能特性

1. **自动检测**：检查所有 OAuth 相关配置
2. **问题诊断**：识别具体的问题原因
3. **修复建议**：提供针对性的解决方案
4. **一键修复**：自动清除数据并重新配置

### 使用步骤

1. 访问 `http://localhost:8082/coze-test`
2. 找到 "OAuth 诊断工具" 部分
3. 点击 "运行诊断" 查看问题
4. 点击 "一键修复" 自动修复
5. 点击 "开始授权" 重新授权

## 联系支持

如果问题仍然存在，请提供：

1. 完整的错误信息
2. 诊断工具的检查结果
3. 浏览器控制台日志
4. 当前环境变量配置
5. OAuth 应用配置截图

---

**注意**：本指南基于扣子平台的 OAuth 2.0 实现。如果平台有更新，请参考最新的官方文档。
